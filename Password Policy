#!/bin/bash
# setup-password-policy.sh
# This script installs pam_pwquality and sets a strong password policy idempotently

set -e

# 1. Install pam_pwquality if not installed
if ! dpkg -l | grep -q libpam-pwquality; then
    echo "Installing libpam-pwquality..."
    apt-get install -y libpam-pwquality
else
    echo "libpam-pwquality is already installed."
fi

# 2. Backup PAM configuration
PAM_FILE="/etc/pam.d/common-password"
if [ ! -f "${PAM_FILE}.bak" ]; then
    echo "Backing up $PAM_FILE to $PAM_FILE.bak"
    cp "$PAM_FILE" "$PAM_FILE.bak"
fi

# 3. Update PAM configuration idempotently
PWLINE="password required pam_pwquality.so enforce_for_root retry=3 minlen=12 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 reject_username difok=3"
if grep -q "pam_pwquality.so" "$PAM_FILE"; then
    echo "Updating existing pam_pwquality settings in $PAM_FILE..."
    sed -i "s|.*pam_pwquality.so.*|$PWLINE|" "$PAM_FILE"
else
    echo "Adding pam_pwquality settings to $PAM_FILE..."
    echo "$PWLINE" >> "$PAM_FILE"
fi

# 4. Backup pwquality.conf
PWQUALITY_CONF="/etc/security/pwquality.conf"
if [ ! -f "${PWQUALITY_CONF}.bak" ]; then
    echo "Backing up $PWQUALITY_CONF to ${PWQUALITY_CONF}.bak"
    cp "$PWQUALITY_CONF" "${PWQUALITY_CONF}.bak"
fi

# 5. Update pwquality.conf idempotently
declare -A settings=(
    [minlen]=12
    [retry]=3
    [ucredit]=-1
    [lcredit]=-1
    [dcredit]=-1
    [ocredit]=-1
    [difok]=3
)

echo "Updating $PWQUALITY_CONF..."
for key in "${!settings[@]}"; do
    value=${settings[$key]}
    if grep -q "^\s*$key\s*=" "$PWQUALITY_CONF"; then
        sed -i "s|^\s*$key\s*=.*|$key = $value|" "$PWQUALITY_CONF"
    else
        echo "$key = $value" >> "$PWQUALITY_CONF"
    fi
done

echo "Password policy setup completed successfully."
